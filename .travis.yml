# Use Dockerized infrastructure
sudo: false
language: python
# Cache our Gcloud SDK between commands
cache:
  directories:
  - "$HOME/google-cloud-sdk/"
env:
# Make sure gcloud command is on our PATH and the App Engine SDK is in the Python path
- GAE_PYTHONPATH=${HOME}/.cache/google_appengine PATH=$PATH:${HOME}/google-cloud-sdk/bin PYTHONPATH=${PYTHONPATH}:${GAE_PYTHONPATH}:${GAE_PYTHONPATH}/lib CLOUDSDK_CORE_DISABLE_PROMPTS=1 CLOUDSDK_PYTHON_SITEPACKAGES=1
before_install:
- cd frontend && yarn install && cd ..
# remove any existing stuff to prepare for GAE install
- if [ -d \"${GAE_PYTHONPATH}\" ]; then rm -r ${GAE_PYTHONPATH}; fi
# Install Google App Engine Python SDK
- python api/tests/fetch_gae_sdk.py $(dirname \"${GAE_PYTHONPATH}\")
  
# [START auth]
# Decrypt the credentials we added to the repo using the key we added with the Travis command line tool
#- openssl aes-256-cbc -K $encrypted_227a0196345f_key -iv $encrypted_227a0196345f_iv -in credentials.tar.gz.enc  -out credentials.tar.gz -d
# If the SDK is not already cached, download it and unpack it 
- if [ ! -d "$HOME/google-cloud-sdk/bin" ]; then 
    # remove existing install
    rm -rf $HOME/google-cloud-sdk; 
    # diable prompts cause its automated
    export CLOUDSDK_CORE_DISABLE_PROMPTS=1; 
    # set permissions on install script
    chmod 775 scripts/install_google_cloud_sdk.bash;
    # install gcloud sdk
    bash scripts/install_google_cloud_sdk.bash;
    # add it to the path
    source /home/travis/google-cloud-sdk/path.bash.inc;
  fi
#- tar -xzf credentials.tar.gz
- mkdir -p lib
# add gcloud to shell
# Here we use the decrypted service account credentials to authenticate the command line tool
# TODO fix this, needs it to be able to actually deploy
#- gcloud auth activate-service-account --key-file client-secret.json
# [END auth]
install:
- ${HOME}/google-cloud-sdk/install.sh
# Set the correct project to deploy to
#- gcloud config set project chuispdetector
- gcloud -q components update gae-python
- gcloud -q components install app-engine-python
- gcloud -q components install app-engine-python-extras
# Install the Python dependencies
# - pip install -r api/tests/requirements.txt -t lib/
- pip install nosegae
- pip install Pillow
script:
# Run the unit tests
- nosetests --with-gae --logging-level=ERROR
# [START deploy]
# Deploy the app disabled until we can get the gcloud auth to work
#- gcloud -q preview app deploy app.yaml --no-promote
#- gcloud -q preview app deploy marriott_service/app.yaml --no-promote
# [END deploy]